---
title: 分布式事务
date: 2019-12-20 00:16:03
tags: 事务
category: 事务
---

![Photo by microcosmos on wallhaven.cc](/transaction.png)

互联网项目一般都是分布式部署的，分布式部署不仅可以提高系统的吞吐量，降低系统之间的耦合性，便于扩展。但是也同样会带来很多问题，比如不同服务间的事务问题。本地事务是保证一组操作要么都执行成功，要么都失败。分布式环境下，要保证不同节点的数据操作需要保证一致性，要么全部成功，要么全部失败。

<!--more-->

### 实现
#### 强一致
XA
#### 弱一致
1. 不用事务，业务补偿冲正
2. 柔性事务，使用事务框架保证事务最终一致
### XA(2PC)
分布式事务协议，基于强一致性思路，是一个数据库本身支持的协议。
X/Open 维护的分布式协议。结构如下：
![来源官方网站](/xa-struct.png)
#### AP
应用程序，一般界定事务的起始和终止，在事务内对资源操作
#### TM
事务管理器，监控事务的执行进度，提交和回滚。
#### RM
资源管理器，数据库/文件系统，并提供访问接口
### 框架
Atomikos 和 Narayana
### BASE柔性事务
BASE 是基本可用，柔性状态和最终一致三要素的缩写。
柔性事务的理念是：通过放宽对强一致性要求，来换取系统吞吐量的提升
#### 三要素
##### Basically-Avaliable
基本可用：保证分布式事务参与方不一定同时在线
##### Soft-state
柔性状态：允许系统状态更新有一定延时，且延时对客户来说不一定能够察觉
##### Eventually-consistent
最终一致性：通过消息传递的方式保证系统的最终一致性
### 实现
#### TCC
通过手动进行补偿处理
#### AT
通过自动进行补偿处理
### TCC
TCC模式即将每个服务业务操作分为两个阶段，第一个阶段检查并预留相关资源，第二阶段根据所有服务业务的Try状态来操作，如果都成功，则进行Confirm操作，如果任意一个Try发生错误，则全部Cancel。 
#### 三阶段
TCC使用要求就是业务接口都必须实现三段逻辑，要么 try-confirm，要么 try-cancel
#### try
准备操作 Try：完成所有业务检查，预留必须的业务资源。
#### confirm 
确认操作 Confirm：真正执行的业务逻辑，不做任何业务检查，只使用 Try 阶段预留的业务资源。因此， 只要 Try 操作成功，Confirm 必须能成功。另外，Confirm 操作需满足幂等性，保证一笔分布式事务能且只能成功一次。
#### cancel 
取消操作 Cancel：释放 Try 阶段预留的业务资源。同样的，Cancel 操作也需要满足幂等性。
#### 注意
TCC 需要注意的几个问题： 1、允许空回滚 2、防悬挂控制 3、幂等设计
### AT
AT 模式是两阶段提交，生成反向 SQL。
### 框架
Seata,Himily,ShardingSphere
### 隔离级别
分布式事务隔离级别
#### XA
相当于加了一个大锁，所有事务排队执行，是一个强一致性事务。
#### 柔性事务
隔离级别：读未提交
在柔性事务机制下，由于网络抖动，CPU 调度问题，没有办法保证多台机器执行的处于分布式事务中的语句是同时执行的，所以就会发生其他事务读到在分布式情况下还没有彻底提交的事务数据。
#### 解决
对表设计要求比较高，将有外键关联的表尽量放在同一个数据库中，处于分布式事务中的表相互没有很大的依赖。或者使用定时任务等方法将数据进行补偿冲正

<center>keep doing</center>