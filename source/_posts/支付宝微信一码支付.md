---
title: 支付宝微信一码支付
date: 2019-12-01 09:26:20
tags: pay
category: pay
---

![Photo by kejsirajbek on wallhaven.cc](/alipay-wechatpay-qr.png)

前几天有个需求要将支付宝和微信扫码集中在同一个二维码上面。当时已经上线了微信各种渠道支付（Native，公众号，H5）,支付宝上线了 Native，H5 支付，于是开始了一码多付的开发。在开发过程中也碰到了一些问题，好在快速解决了问题。
<!--more-->


##### 问题

1. 微信
从微信官方文档了解到扫码支付需要使用公众号支付方式拉起支付进行支付，这个过程需要进行用户认证等操作，从开发的角度来讲比较麻烦，而且多了认证操作，虽然可以使用静默授权（微信提供的一种用户无感知的授权方式）但是在加载过程中需要耗费更多的时间，用户体验降低。
2. 支付宝
支付宝支付在官方了解到使用当面付功能可以完成扫码支付，前端 jssdk 也具备拉起的方式。但是在开发过程中发现公司账号没有开通此功能，申请需要 1-2 天时间，时间上来不及，于是和前端同学试了支付宝也采用 H5 支付的方式，结果完美解决。支付宝还是很方便的，在交互还是开发方面。
3. 对账
这里其实可以不用回调也可以的，因为没有业务逻辑需要在回调处理，但是因为公司也使用H5,Native 支付 方式，所以这里需要记录下，方便后期对账等操作。

##### 思路
前端页面使用 userAgent 判断是微信还是支付宝扫码进入的，如果是支付宝，跳转到支付宝 H5 支付的方式，后端返回 H5 支付返回的 Form 表单，前端直接拉起支付宝支付。如果是微信扫码进来，则跳转到微信支付静默授权链接，后端处理跳转到相应的 H5 支付页面进行处理。

##### alipay

1. 引入支付宝提供的 SDK

```xml
<!--支付宝sdk-->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.7.1.ALL</version>
</dependency>
```

2. 配置文件
```properties
# 是否启用沙盒支付
alipay.sandbox=false
# 支付宝后台获取 appId
alipay.appId=your.app.id
# 私有 key
alipay.privateKey=your.private.key
# 公有 key
alipay.alipayPublicKey=your.public.key
# 回调
alipay.qr.notifyUrl=https://${your.domain}/alipay/notify
```

3. 配置
```java
@Data
@Component
public class AlipayProperties {

    /**
     * 是否沙箱环境
     */
    @Value("${alipay.sandbox}")
    private Boolean isTest;
    /**
     * 应用ID
     */
    @Value("${alipay.appId}")
    private String appId;
    /**
     * 应用私钥
     */
    @Value("${alipay.privateKey}")
    private String privateKey;
    /**
     * 支付宝公钥
     */
    @Value("${alipay.alipayPublicKey}")
    private String alipayPublicKey;

    /**
     * 支付异步回调地址
     */
    @Value("${alipay.notifUrl}")
    private String notifyUrl;

    /**
     * 获取当前配置环境网关
     */
    public String obtainUrl() {
        // 沙盒环境
        if (this.isTest) {
            return "https://openapi.alipaydev.com/gateway.do";
        } else {
            return "https://openapi.alipay.com/gateway.do";
        }
    }

}

```

4. 对接

**支付controller**
```java
/**
    * 支付宝扫码支付
    */
@RequestMapping("/alipay")
public ResponseMsg qrAlipay(HttpServletRequest request,
                            @RequestBody QrPayRequestParams qrPayRequestParams,
                            @RequestHeader(value = "activityId", required = false) String activityId) {
    // 参数校验省略
    qrPayRequestParams.setRemoteAddr(request.getRemoteAddr());
    // 活动标记
    qrPayRequestParams.setActivityId(activityId);
    log.info("支付宝扫码参数：{}", qrPayRequestParams.toString());
    AliResultParams params = qrPaymentService.qrAlipay(qrPayRequestParams);
    ResponseMsg<AliResultParams> msg = new ResponseMsg<>(Code.SUCCESSED, Constants.SUCCESS);
    msg.setData(params);
    return msg;
}
```
**支付service**
```java
/**
    * 支付宝扫码支付
    * @param qrPayRequestParams params
    * @return form table
    */
@Override
public AliResultParams qrAlipay(QrPayRequestParams qrPayRequestParams) {
    // 创建订单-根据具体业务
    //QrRechargeOrder order = qrRechargeOrderService.createOrder(qrPayRequestParams, QrPayConstants.PAYWAY_ALIPAY);
    // 支付宝支付
    AlipayClient alipayClient = new DefaultAlipayClient(alipayProperties.obtainUrl(),
            alipayProperties.getAppId(), alipayProperties.getPrivateKey(),
            AlipayConstants.FORMAT_JSON, AlipayConstants.CHARSET_UTF8, alipayProperties.getAlipayPublicKey(),
            AlipayConstants.SIGN_TYPE_RSA2);
    AlipayTradeWapPayRequest request = new AlipayTradeWapPayRequest();
    AlipayTradeWapPayModel model = new AlipayTradeWapPayModel();
    //该笔订单允许的最晚付款时间，逾期将关闭交易。
    model.setTimeoutExpress("30m");
    model.setTotalAmount(qrPayRequestParams.getMoney());
    model.setSubject("XXXX");
    // 更具具体业务生成的订单号
    //model.setOutTradeNo(order.getRechargeOrderId());
    model.setOutTradeNo("201912011111111111");
    model.setProductCode("XXXX");
    request.setBizModel(model);
    request.setNotifyUrl(alipayQrNotifyUrl);
    request.setReturnUrl(qrPayRequestParams.getReturnUrl());
    try {
        log.info("支付宝扫码请求参数：{}",request.getTextParams());
        AlipayTradeWapPayResponse response = alipayClient.pageExecute(request);
        log.info("请求信息：{}",response.getBody());
        AliResultParams params = AliResultParams.builder().alipayParams(response.getBody()).build();
        if (response.getBody().contains(model.getOutTradeNo())) {
            params.setAlipayTradeNo(model.getOutTradeNo());
        }
        return params;
    } catch (AlipayApiException e) {
        e.printStackTrace();
        return AliResultParams.builder().build();
    }
}
```
**回调controller**
```java
/**
 * 支付宝扫码回调
 */
@RequestMapping("/alipay/notify")
public String alipayNotify(HttpServletRequest request) {
    log.info("进入支付宝扫码支付回调");
    try {
        return qrPaymentService.alipayNotify(request);
    } catch (AlipayApiException e) {
        e.printStackTrace();
        log.info("支付宝扫码支付回调失败");
        return "fail";
    }
}
```
**回调service**
```java
/**
 * 支付宝扫码支付回调
 */
@Override
public String alipayNotify(HttpServletRequest request) throws AlipayApiException {
    Map<String, String> map;
    Map<String, String[]> requestParams = request.getParameterMap();
    map = this.paramsString(requestParams);
    String outTradeNo = map.get("out_trade_no");
    String tradeStatus = map.get("trade_status");
    String tradeNo = map.get("trade_no");
    boolean signVerified = AlipaySignature.rsaCheckV1(map, alipayProperties.getAlipayPublicKey(),
            AlipayConstants.CHARSET_UTF8, AlipayConstants.SIGN_TYPE_RSA2);
    log.info("支付宝扫码参数：out_trade_no：{}，trade_status，{}，trade_no，{}，校验结果：{}",
            outTradeNo, tradeStatus, tradeNo,signVerified);
    // 校验订单-省略
    
    // 验签通过，验证金额通过
    return "success";
    // 检验失败
    return "fail";
}

/**
 * 拼接参数
 */
private Map<String, String> paramsString(Map<String, String[]> requestParams) {
    Map<String, String> map = new HashMap<>();
    for (String name : requestParams.keySet()) {
        String[] values = requestParams.get(name);
        String valueStr = "";
        for (int i = 0; i < values.length; i++) {
            valueStr = (i == values.length - 1) ? valueStr + values[i] : valueStr + values[i] + ",";
            System.out.println(valueStr);
        }
        map.put(name, valueStr);
    }
    log.info("支付宝扫码支付参数：{}",map);
    return map;
}
```
**entity**
```java
// 封装微信和支付宝请求实体
@Data
@ToString
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class QrPayRequestParams {

    private String openId;

    /**
     * 金额 - 元
     */
    private Double money;

    private String remoteAddr;
    private String activityId;
    private String returnUrl;
}

// 封装支付宝返回参数信息
@Data
@ToString
@Builder
public class AliResultParams {
    private String alipayParams;
    private String alipayTradeNo;
}
```









